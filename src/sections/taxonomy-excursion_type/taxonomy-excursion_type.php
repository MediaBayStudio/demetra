<?php
  $date = $_GET['date'];
  $excursion_type = $_GET['excursion_type'];
  $excursions;

  if (!$excursion_type) {
    $excursion_type = 'all';
  };

  $days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
  $query_day = $days[ date('w', strtotime($date)) ];
  if ( !$date && $excursion_type === 'all' ) {
    $excursions = get_posts([
      'post_type' => 'excursion',
      'meta_key'  => 'in_popular',
      'orderby'   => 'meta_value_num',
      'order'     => 'DESC'
    ]);
  } else {
    $query_args = [
      'post_type' => 'excursion',
      'numberposts' => -1,

      'meta_query'     => [
        'relation' => 'OR',
        [
          'key'   => 'all_days',
          'value' => 1,
        ],
        [
          'key'   => $query_day,
          'value' => 1,
        ]
      ],

      'meta_key'  => 'in_popular',
      'orderby'   => 'meta_value_num',
      'order'     => 'DESC'
    ];

    if ( $excursion_type !== 'all' ) {
      $query_args = array_merge($query_args,
        [
          'tax_query' => [
            [
              'taxonomy' => 'excursion_type',
              'field'    => 'slug',
              'terms'    => $excursion_type
            ]
          ]
        ]
      );
    };

    $excursions = get_posts($query_args);
  };

  $filters_list = get_terms('excursion_filters');
?>
<section class="display-excursions sect container">
  <div class="display-excursions__filters filters" <?php echo !$excursions ? 'hidden' : '' ?>>
    <div class="filters-mob-menu">
      <button class="filters-mob-menu__close-btn">&#9587;</button>
      <h3 class="filters-mob-menu__title sect-title">Фильтры</h3>
      <ul class="filters-list filters-list-mob">
        <?php foreach ( $filters_list as $filter ) : ?>
          <li class="filters-item filters-item-mob" data-filter-id="<?php echo $filter->term_id ?>" role="button"><?php echo $filter->name ?></li>
        <?php endforeach ?>
      </ul>
      <button class="btn btn-yellow filters-accept-btn">Применить</button>
      <button class="filters-reset-btn filters-reset-btn-mob">Сбросить фильтры</button>
    </div>

    <div class="filters-bar">
      <button class="filters-open-mob-btn lazy" data-src="#">Фильтры</button>
      <button class="filters-reset-btn" tabindex="1">Сбросить фильтры</button>
    </div>

    <ul class="filters-list filters-list-desk">
      <?php foreach ( $filters_list as $filter ) : ?>
        <li class="filters-item filters-item-desk" data-filter-id="<?php echo $filter->term_id ?>" role="button"><?php echo $filter->name ?></li>
      <?php endforeach ?>
    </ul>

    <div class="filters__sort-by">
      <select id="sort-by-select" class="filters__sort-by-select">
        <option value="popular" selected>Сначала популярные</option>
        <option value="price_up">По возрастанию цены</option>
        <option value="price_down">По убыванию цены</option>
      </select>
    </div>
  </div>

  <?php if ( $excursions ) : ?>
    <ul class="display-excursions__list">

        <?php foreach ( $excursions as $excursion ) : ?>
          <li class="display-excursions__list-item">
            <?php getCardPreview( $excursion ) ?>
          </li>
        <?php endforeach ?>

    </ul>
  <?php else : ?>
    <div class="display-excursions__no-results">
      <p>
        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M58.5975 31.041C58.187 30.2092 49.4044 15.7321 49.1819 15.3706C47.5424 12.7099 44.7006 11.1216 41.58 11.1216C41.1348 11.1216 40.6976 11.1553 40.2697 11.2186C40.2693 11.2178 40.2681 11.216 40.2678 11.2156C39.5116 9.99014 38.2027 9.25842 36.7667 9.25842C34.4993 9.25842 32.6546 11.1031 32.6546 13.3705V20.5555H27.3453V13.3705C27.3453 11.1032 25.5007 9.25842 23.2332 9.25842C21.7998 9.25842 20.4934 9.98745 19.7305 11.2186C19.3026 11.1553 18.8652 11.1216 18.4198 11.1216C15.2993 11.1216 12.4575 12.7101 10.8179 15.3708C10.7953 15.4075 10.7265 15.5193 9.07393 18.2897C8.78987 18.7659 8.94573 19.3824 9.42186 19.6664C9.89811 19.9504 10.5145 19.7948 10.7986 19.3185C12.1584 17.039 12.4896 16.4863 12.5279 16.4241C13.7989 14.3613 16.0016 13.1298 18.42 13.1298C22.2342 13.1298 25.3371 16.2328 25.3371 20.0469V20.0475V29.9427C22.9312 26.0191 18.6027 23.3961 13.6727 23.3961C11.4463 23.3961 9.34264 23.9314 7.48323 24.8794C7.96077 24.0782 8.46526 23.2317 8.97151 22.3828C9.25545 21.9064 9.09959 21.29 8.62323 21.0061C8.14686 20.7222 7.53057 20.878 7.24651 21.3544C5.113 24.9326 1.755 30.3016 1.33078 31.188C0.478124 32.9701 0 34.9646 0 37.069C0 44.6081 6.13358 50.7417 13.6727 50.7417C21.2118 50.7417 27.3453 44.6081 27.3453 37.069V34.401H32.6546V37.069C32.6546 44.6081 38.7882 50.7417 46.3272 50.7417C53.8663 50.7417 59.9999 44.6081 59.9999 37.069C60 34.9066 59.4953 32.8603 58.5975 31.041ZM25.3371 14.4141C24.4094 13.277 23.2078 12.3726 21.8335 11.8015C22.2137 11.4605 22.7066 11.2667 23.2333 11.2667C24.3934 11.2667 25.3371 12.2104 25.3371 13.3704V14.4141ZM13.6727 48.7332C7.24089 48.7332 2.00824 43.5007 2.00824 37.0688C2.00824 30.637 7.24089 25.4044 13.6727 25.4044C20.1045 25.4044 25.3371 30.637 25.3371 37.0688C25.3371 43.5007 20.1044 48.7332 13.6727 48.7332ZM27.3452 28.537V22.5636H32.6545V28.537H27.3452V28.537ZM32.6546 32.3927H27.3453V30.5454H32.6546V32.3927ZM34.6628 13.3705C34.6628 12.2105 35.6065 11.2668 36.7666 11.2668C37.295 11.2668 37.7895 11.4619 38.1677 11.8012C36.7929 12.3722 35.5907 13.2769 34.6628 14.4142V13.3705ZM34.6628 20.0475V20.0469C34.6628 16.2327 37.7658 13.1298 41.5799 13.1298C43.9984 13.1298 46.201 14.3615 47.472 16.4241C47.5924 16.6197 50.1021 20.8284 52.5167 24.8794C50.6571 23.9313 48.5535 23.396 46.3271 23.396C41.3971 23.396 37.0686 26.0191 34.6627 29.9426V20.0475H34.6628ZM46.3273 48.7332C39.8955 48.7332 34.6629 43.5005 34.6629 37.0687C34.6629 30.6369 39.8956 25.4043 46.3273 25.4043C52.7591 25.4043 57.9918 30.6369 57.9918 37.0687C57.9918 43.5005 52.759 48.7332 46.3273 48.7332Z" fill="#2B4758"/>
          <path d="M55.1304 33.9046C54.9427 33.3829 54.3678 33.1118 53.8458 33.2995C53.3241 33.4871 53.0531 34.0622 53.2407 34.5841C53.5264 35.3789 53.6713 36.215 53.6713 37.0688C53.6713 41.1184 50.3768 44.413 46.3271 44.413C42.2774 44.413 38.9828 41.1184 38.9828 37.0688C38.9828 33.0191 42.2774 29.7245 46.3271 29.7245C48.3595 29.7245 50.3195 30.5784 51.7049 32.067C52.0827 32.4729 52.718 32.4958 53.1242 32.118C53.5301 31.7402 53.553 31.1049 53.1752 30.6987C51.4114 28.8033 48.9153 27.7162 46.3271 27.7162C41.17 27.7162 36.9746 31.9116 36.9746 37.0687C36.9746 42.2257 41.17 46.4212 46.3271 46.4212C51.4841 46.4212 55.6796 42.2257 55.6796 37.0687C55.6797 35.9828 55.4949 34.9182 55.1304 33.9046Z" fill="#2B4758"/>
          <path d="M13.6728 27.7164C8.51573 27.7164 4.32031 31.9119 4.32031 37.0689C4.32031 42.226 8.51573 46.4214 13.6728 46.4214C18.8299 46.4214 23.0253 42.226 23.0253 37.0689C23.0253 31.9119 18.8297 27.7164 13.6728 27.7164ZM13.6728 44.413C9.62315 44.413 6.32855 41.1186 6.32855 37.0688C6.32855 33.0192 9.62304 29.7246 13.6728 29.7246C17.7226 29.7246 21.017 33.019 21.017 37.0688C21.017 41.1186 17.7223 44.413 13.6728 44.413Z" fill="#2B4758"/>
        </svg>
        <br>
        Мы ничего не нашли по вашему запросу :(
        <br>
        Попробуйте выбрать другую дату или поменять тип экскурсии
        <br>
        <a href="<?php echo get_home_url() . '/vse-ekskursii' ?>" class="display-excursions__no-results-link">Показать все экскурсии</a>
      </p>
    </div>
  <?php endif ?>
    <div class="display-excursions__filters-no-results" hidden>
      <p>
        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M58.5975 31.041C58.187 30.2092 49.4044 15.7321 49.1819 15.3706C47.5424 12.7099 44.7006 11.1216 41.58 11.1216C41.1348 11.1216 40.6976 11.1553 40.2697 11.2186C40.2693 11.2178 40.2681 11.216 40.2678 11.2156C39.5116 9.99014 38.2027 9.25842 36.7667 9.25842C34.4993 9.25842 32.6546 11.1031 32.6546 13.3705V20.5555H27.3453V13.3705C27.3453 11.1032 25.5007 9.25842 23.2332 9.25842C21.7998 9.25842 20.4934 9.98745 19.7305 11.2186C19.3026 11.1553 18.8652 11.1216 18.4198 11.1216C15.2993 11.1216 12.4575 12.7101 10.8179 15.3708C10.7953 15.4075 10.7265 15.5193 9.07393 18.2897C8.78987 18.7659 8.94573 19.3824 9.42186 19.6664C9.89811 19.9504 10.5145 19.7948 10.7986 19.3185C12.1584 17.039 12.4896 16.4863 12.5279 16.4241C13.7989 14.3613 16.0016 13.1298 18.42 13.1298C22.2342 13.1298 25.3371 16.2328 25.3371 20.0469V20.0475V29.9427C22.9312 26.0191 18.6027 23.3961 13.6727 23.3961C11.4463 23.3961 9.34264 23.9314 7.48323 24.8794C7.96077 24.0782 8.46526 23.2317 8.97151 22.3828C9.25545 21.9064 9.09959 21.29 8.62323 21.0061C8.14686 20.7222 7.53057 20.878 7.24651 21.3544C5.113 24.9326 1.755 30.3016 1.33078 31.188C0.478124 32.9701 0 34.9646 0 37.069C0 44.6081 6.13358 50.7417 13.6727 50.7417C21.2118 50.7417 27.3453 44.6081 27.3453 37.069V34.401H32.6546V37.069C32.6546 44.6081 38.7882 50.7417 46.3272 50.7417C53.8663 50.7417 59.9999 44.6081 59.9999 37.069C60 34.9066 59.4953 32.8603 58.5975 31.041ZM25.3371 14.4141C24.4094 13.277 23.2078 12.3726 21.8335 11.8015C22.2137 11.4605 22.7066 11.2667 23.2333 11.2667C24.3934 11.2667 25.3371 12.2104 25.3371 13.3704V14.4141ZM13.6727 48.7332C7.24089 48.7332 2.00824 43.5007 2.00824 37.0688C2.00824 30.637 7.24089 25.4044 13.6727 25.4044C20.1045 25.4044 25.3371 30.637 25.3371 37.0688C25.3371 43.5007 20.1044 48.7332 13.6727 48.7332ZM27.3452 28.537V22.5636H32.6545V28.537H27.3452V28.537ZM32.6546 32.3927H27.3453V30.5454H32.6546V32.3927ZM34.6628 13.3705C34.6628 12.2105 35.6065 11.2668 36.7666 11.2668C37.295 11.2668 37.7895 11.4619 38.1677 11.8012C36.7929 12.3722 35.5907 13.2769 34.6628 14.4142V13.3705ZM34.6628 20.0475V20.0469C34.6628 16.2327 37.7658 13.1298 41.5799 13.1298C43.9984 13.1298 46.201 14.3615 47.472 16.4241C47.5924 16.6197 50.1021 20.8284 52.5167 24.8794C50.6571 23.9313 48.5535 23.396 46.3271 23.396C41.3971 23.396 37.0686 26.0191 34.6627 29.9426V20.0475H34.6628ZM46.3273 48.7332C39.8955 48.7332 34.6629 43.5005 34.6629 37.0687C34.6629 30.6369 39.8956 25.4043 46.3273 25.4043C52.7591 25.4043 57.9918 30.6369 57.9918 37.0687C57.9918 43.5005 52.759 48.7332 46.3273 48.7332Z" fill="#2B4758"/>
          <path d="M55.1304 33.9046C54.9427 33.3829 54.3678 33.1118 53.8458 33.2995C53.3241 33.4871 53.0531 34.0622 53.2407 34.5841C53.5264 35.3789 53.6713 36.215 53.6713 37.0688C53.6713 41.1184 50.3768 44.413 46.3271 44.413C42.2774 44.413 38.9828 41.1184 38.9828 37.0688C38.9828 33.0191 42.2774 29.7245 46.3271 29.7245C48.3595 29.7245 50.3195 30.5784 51.7049 32.067C52.0827 32.4729 52.718 32.4958 53.1242 32.118C53.5301 31.7402 53.553 31.1049 53.1752 30.6987C51.4114 28.8033 48.9153 27.7162 46.3271 27.7162C41.17 27.7162 36.9746 31.9116 36.9746 37.0687C36.9746 42.2257 41.17 46.4212 46.3271 46.4212C51.4841 46.4212 55.6796 42.2257 55.6796 37.0687C55.6797 35.9828 55.4949 34.9182 55.1304 33.9046Z" fill="#2B4758"/>
          <path d="M13.6728 27.7164C8.51573 27.7164 4.32031 31.9119 4.32031 37.0689C4.32031 42.226 8.51573 46.4214 13.6728 46.4214C18.8299 46.4214 23.0253 42.226 23.0253 37.0689C23.0253 31.9119 18.8297 27.7164 13.6728 27.7164ZM13.6728 44.413C9.62315 44.413 6.32855 41.1186 6.32855 37.0688C6.32855 33.0192 9.62304 29.7246 13.6728 29.7246C17.7226 29.7246 21.017 33.019 21.017 37.0688C21.017 41.1186 17.7223 44.413 13.6728 44.413Z" fill="#2B4758"/>
        </svg>
        <br>
        Нет подходящих экскурсий :(
        <br>
        Попробуйте убрать часть фильтров или
        <br>
        <button class="filters-reset-btn">Сбросить фильтры</button>
      </p>
    </div>
</section>